<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç¿’æ…£ã‚¿ã‚¤ãƒ ãƒˆãƒ©ãƒƒã‚«ãƒ¼ â€” æœ€çµ‚ç‰ˆ</title>
  <link rel="icon" href="data:;base64,iVBORw0KGgo=" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" defer></script>
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500;700&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#0b0f14; --card:#121826; --text:#e6edf7; --muted:#9fb0c6; --pink:#ff5ac8; --green:#22d3a6; --accent:#7c5cff; --line:#233; }
    *{ box-sizing:border-box }
    body{ margin:0; font-family: 'Zen Maru Gothic', system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; color:var(--text);
      background: radial-gradient(1200px 800px at 20% -10%, rgba(124,92,255,.25), transparent),
                  radial-gradient(800px 600px at 120% 20%, rgba(255,90,200,.2), transparent), var(--bg); }
    header{ padding:16px 20px; border-bottom:1px solid var(--line); position:sticky; top:0; backdrop-filter:blur(6px); background:rgba(11,15,20,.75); z-index:5; }
    header h1{ margin:0; font-size:18px; letter-spacing:.5px }
    .wrap{ max-width:1100px; margin:0 auto; padding:18px }
    .card{ background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0)); border:1px solid var(--line); border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.2), inset 0 1px 0 rgba(255,255,255,.04) }
    .card h2{ margin:0 0 10px; font-size:16px; color:#cfe2ff; letter-spacing:.3px }
    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px }
    input[type="text"], input[type="number"], select{ width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:#0f1523; color:var(--text) }
    .row{ display:grid; gap:10px; grid-template-columns:1fr }
    @media (min-width:640px){ .row.two{ grid-template-columns:1fr 1fr } .row.three{ grid-template-columns:1fr 1fr 1fr } }
    button{ cursor:pointer; padding:10px 14px; border-radius:12px; border:1px solid var(--line); background:#121a2b; color:var(--text); transition:transform .02s ease, box-shadow .2s ease }
    button:hover{ box-shadow:0 6px 20px rgba(124,92,255,.25) }
    button:active{ transform:translateY(1px) }
    .btn-primary{ background:linear-gradient(90deg, var(--accent), var(--pink)); border:none }
    .btn-green{ background:linear-gradient(90deg, #1fbfb4, var(--green)); border:none }
    .danger{ color:#ff6b6b }
    .muted{ color:var(--muted); font-size:12px }
    .table{ width:100%; border-collapse:collapse; font-size:12px }
    .table th,.table td{ padding:8px; border-bottom:1px solid var(--line) }
    canvas{ background:rgba(255,255,255,.02); border-radius:12px; padding:8px }
    .small{ font-size:11px }
    /* Tabs */
    .tabs{ margin-top:8px; display:flex; gap:8px; flex-wrap:wrap }
    .tab-btn{ cursor:pointer; padding:8px 12px; border-radius:999px; border:1px solid var(--line); background:#0f1523; color:var(--text) }
    .tab-btn.active{ background:linear-gradient(90deg, var(--accent), var(--pink)); border:none }
    .tab{ display:none }
    .tab.active{ display:block }
    .tag{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--line); border-radius:999px; background:#0f1523 }
    .tag .dot{ width:10px; height:10px; border-radius:50% }
    .habits{ display:flex; flex-wrap:wrap; gap:8px }
    /* Home: quote */
    .quote{ margin-top:10px; padding:12px 14px; border:1px dashed rgba(255,255,255,.15); border-radius:14px; background:linear-gradient(90deg, rgba(124,92,255,.12), rgba(34,211,166,.12)); }
    .quote .text{ font-family:"Dancing Script", cursive; font-size:28px; line-height:1.2; letter-spacing:.3px }
    .quote .author{ margin-top:6px; font-size:12px; color:#cfe2ff; opacity:.9 }
  </style>
</head>
<body>
  <header>
    <h1>ç¿’æ…£ã‚¿ã‚¤ãƒ ãƒˆãƒ©ãƒƒã‚«ãƒ¼ â±ï¸</h1>
    <nav class="tabs">
      <button class="tab-btn active" data-tab="tab-home">ãƒ›ãƒ¼ãƒ </button>
      <button class="tab-btn" data-tab="tab-habits">ç¿’æ…£</button>
      <button class="tab-btn" data-tab="tab-log">è¨˜éŒ²</button>
      <button class="tab-btn" data-tab="tab-timer">ã‚¿ã‚¤ãƒãƒ¼</button>
      <button class="tab-btn" data-tab="tab-charts">ã‚°ãƒ©ãƒ•</button>
      <button class="tab-btn" data-tab="tab-data">ãƒ‡ãƒ¼ã‚¿</button>
    </nav>
  </header>

  <div class="wrap">
    <!-- ãƒ›ãƒ¼ãƒ ï¼šè¤‡åˆ©ã‚°ãƒ©ãƒ• + åè¨€ -->
    <section class="tab active" id="tab-home">
      <section class="card">
        <h2>è¤‡åˆ©ã®åŠ›ï¼ˆãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰</h2>
        <div class="row three">
          <div>
            <label>å¯¾è±¡</label>
            <select id="comp-habit"></select>
          </div>
          <div>
            <label>1æ—¥ã®ç›®æ¨™æ™‚é–“ï¼ˆåˆ†ï¼‰= 1%</label>
            <input id="comp-goal" type="number" min="1" step="1" placeholder="ä¾‹ï¼š30" />
          </div>
          <div>
            <label>æœŸé–“</label>
            <select id="comp-range">
              <option value="30">ç›´è¿‘30æ—¥</option>
              <option value="90">ç›´è¿‘90æ—¥</option>
              <option value="365" selected>ç›´è¿‘1å¹´</option>
              <option value="all">å…¨æœŸé–“</option>
            </select>
          </div>
        </div>
        <div style="display:flex; gap:8px; margin-top:10px; flex-wrap:wrap;">
          <button class="btn-primary" onclick="renderCompounding()">è¤‡åˆ©ã‚°ãƒ©ãƒ•æ›´æ–°</button>
          <div class="muted small" id="comp-stats">â€”</div>
        </div>
        <div style="margin-top:12px">
          <canvas id="compChart" height="180"></canvas>
        </div>
        <div class="quote" id="quoteBox" style="margin-top:14px;">
          <div class="text" id="quoteText">""</div>
          <div class="author" id="quoteAuthor"></div>
        </div>
        <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;">
          <button onclick="shuffleQuote()">åè¨€ã‚’æ›´æ–°</button>
        </div>
      </section>
    </section>

    <!-- ç¿’æ…£ã‚¿ãƒ– -->
    <section class="tab" id="tab-habits">
      <section class="card">
        <h2>ç¿’æ…£ã®è¿½åŠ ãƒ»ç®¡ç†</h2>
        <div class="row two">
          <div>
            <label>ç¿’æ…£å</label>
            <input id="habit-name" type="text" placeholder="ä¾‹ï¼šè‹±å˜èªã€èª­æ›¸ã€ç­‹ãƒˆãƒ¬" />
          </div>
          <div>
            <label>è‰²ï¼ˆä»»æ„ï¼‰</label>
            <input id="habit-color" type="text" placeholder="#ff5ac8 ã¾ãŸã¯ red" />
          </div>
        </div>
        <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn-primary" onclick="addHabit()">ï¼‹ è¿½åŠ </button>
          <button class="danger" onclick="resetAll()">å…¨ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–</button>
        </div>
        <div style="margin-top:14px">
          <div class="habits" id="habit-tags"></div>
          <div class="muted small" style="margin-top:6px">ãƒ’ãƒ³ãƒˆï¼šã‚¿ã‚°ã‚’ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠã€å³ã‚¯ãƒªãƒƒã‚¯ã§å‰Šé™¤ã€‚</div>
        </div>
      </section>
    </section>

    <!-- è¨˜éŒ²ã‚¿ãƒ– -->
    <section class="tab" id="tab-log">
      <section class="card">
        <h2>æ‰‹å‹•ã§æ™‚é–“ã‚’è¨˜éŒ²</h2>
        <div class="row two">
          <div>
            <label>ç¿’æ…£ã®é¸æŠ</label>
            <select id="habit-select"></select>
          </div>
          <div>
            <label>å–ã‚Šçµ„ã¿æ™‚é–“ï¼ˆåˆ†ï¼‰</label>
            <input id="minutes" type="number" min="1" step="1" placeholder="ä¾‹ï¼š25" />
          </div>
        </div>
        <div class="row two" style="margin-top:10px;">
          <div>
            <label>ä»»æ„ã®è¨˜éŒ²æ—¥æ™‚ï¼ˆæœªæŒ‡å®šãªã‚‰ç¾åœ¨æ™‚åˆ»ï¼‰</label>
            <input id="when" type="datetime-local" />
          </div>
          <div style="display:flex; align-items:end; gap:8px;">
            <button class="btn-green" onclick="logTime()">ğŸ“ è¨˜éŒ²ã™ã‚‹</button>
            <button onclick="clearToday()" title="ä»Šæ—¥ã®è¨˜éŒ²ã ã‘æ¶ˆã™">ä»Šæ—¥ã®ã¿å‰Šé™¤</button>
          </div>
        </div>
        <div style="margin-top:14px">
          <table class="table" id="log-table">
            <thead><tr><th>æ—¥æ™‚</th><th>ç¿’æ…£</th><th>åˆ†</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </section>

    <!-- ã‚¿ã‚¤ãƒãƒ¼ã‚¿ãƒ– -->
    <section class="tab" id="tab-timer">
      <section class="card">
        <h2>ä»Šã‚„ã‚‹ã‚¿ã‚¤ãƒãƒ¼ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰OKï¼‰</h2>
        <div class="row two">
          <div>
            <label>ç¿’æ…£ã®é¸æŠ</label>
            <select id="timer-habit"></select>
          </div>
          <div>
            <label>ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
            <input id="timer-note" type="text" placeholder="ä¾‹ï¼šå•é¡Œé›†#3" />
          </div>
        </div>
        <div style="display:flex; align-items:center; gap:10px; margin-top:12px;">
          <div id="timer-display" style="font-size:28px; font-variant-numeric: tabular-nums;">00:00:00</div>
          <div class="muted small" id="timer-status">å¾…æ©Ÿä¸­</div>
        </div>
        <div style="display:flex; gap:8px; margin-top:10px; flex-wrap:wrap;">
          <button class="btn-primary" id="btn-start" onclick="timerStart()">â–¶ é–‹å§‹</button>
          <button id="btn-pause" onclick="timerPause()" style="display:none;">â¸ ä¸€æ™‚åœæ­¢</button>
          <button id="btn-resume" onclick="timerResume()" style="display:none;">â†» å†é–‹</button>
          <button class="danger" onclick="timerReset()">âŸ² ãƒªã‚»ãƒƒãƒˆ</button>
          <button class="btn-green" onclick="timerCommit()">ğŸ“ ãƒ­ã‚°ã«è¿½åŠ </button>
        </div>
        <p class="muted small" style="margin-top:8px">
          ä»•çµ„ã¿ï¼šã‚¿ã‚¤ãƒãƒ¼ã¯ <b>é–‹å§‹æ™‚åˆ»ã¨ç¾åœ¨æ™‚åˆ»ã®å·®</b> ã§è¨ˆç®—ã™ã‚‹ãŸã‚ã€
          ç”»é¢ã‚’é–‰ã˜ãŸã‚Šä»–ã‚¢ãƒ—ãƒªã«åˆ‡ã‚Šæ›¿ãˆã¦ã‚‚æ­£ç¢ºã«é€²ã¿ã¾ã™ã€‚å¯¾å¿œç«¯æœ«ã§ã¯ <i>Wake Lock API</i> ã§ç”»é¢æ¶ˆç¯é˜²æ­¢ã‚‚è©¦ã¿ã¾ã™ã€‚
        </p>
      </section>
    </section>

    <!-- ã‚°ãƒ©ãƒ•ã‚¿ãƒ– -->
    <section class="tab" id="tab-charts">
      <section class="card">
        <h2>å¯è¦–åŒ–</h2>
        <div class="row two">
          <div>
            <label>å¯¾è±¡ã®ç¿’æ…£</label>
            <select id="chart-habit"></select>
          </div>
          <div>
            <label>æœŸé–“</label>
            <select id="range-select">
              <option value="30">ç›´è¿‘30æ—¥</option>
              <option value="90">ç›´è¿‘90æ—¥</option>
              <option value="365" selected>ç›´è¿‘1å¹´</option>
              <option value="all">å…¨æœŸé–“</option>
            </select>
          </div>
        </div>
        <div class="row three" style="margin-top:10px">
          <button onclick="renderAllCharts()">ã‚°ãƒ©ãƒ•æ›´æ–°</button>
          <button onclick="toggleAvgMode()" id="avg-btn" title="æ—¥æ¬¡â†’7æ—¥å¹³å‡â†’30æ—¥å¹³å‡ ã¨åˆ‡æ›¿">å¹³å‡: æ—¥æ¬¡</button>
        </div>
        <div class="stack" style="margin-top:12px">
          <div>
            <div class="muted small">â‘  ç´¯è¨ˆæ™‚é–“ï¼ˆé¸æŠã—ãŸç¿’æ…£ï¼‰</div>
            <canvas id="cumChart" height="120"></canvas>
          </div>
          <div>
            <div class="muted small">â‘¡ æ—¥ã”ã¨ã®å–ã‚Šçµ„ã¿æ™‚é–“ï¼ˆå¹³å‡ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿å¯ï¼‰</div>
            <canvas id="dailyChart" height="160"></canvas>
          </div>
          <div>
            <div class="muted small">â‘¢ ä¸€æ—¥ã®ã©ã®æ™‚é–“å¸¯ã«ã‚„ã£ã¦ã„ã‚‹ã‹ï¼ˆ0â€“23æ™‚ï¼‰</div>
            <canvas id="todChart" height="120"></canvas>
          </div>
          <div>
            <div class="muted small">â‘£ é …ç›®ãƒãƒ©ãƒ³ã‚¹ï¼ˆ100%å¸¯ã‚°ãƒ©ãƒ•ï¼æ—¥ï¼‰</div>
            <canvas id="stackChart" height="160"></canvas>
          </div>
          <div>
            <div class="muted small">â‘¤ é …ç›®ã”ã¨ã®ç´¯è¨ˆæ™‚é–“ï¼ˆå††ã‚°ãƒ©ãƒ•ï¼‰</div>
            <canvas id="pieChart" height="180"></canvas>
          </div>
        </div>
      </section>
    </section>

    <!-- ãƒ‡ãƒ¼ã‚¿ã‚¿ãƒ– -->
    <section class="tab" id="tab-data">
      <section class="card">
        <h2>ãƒ‡ãƒ¼ã‚¿ã®æ›¸ãå‡ºã—ï¼èª­ã¿è¾¼ã¿</h2>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button onclick="exportData()">ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãå‡ºã—</button>
          <label class="tag" style="cursor:pointer">
            <input id="import-file" type="file" accept=".json" style="display:none" onchange="importData(event)" />
            <span onclick="document.getElementById('import-file').click()">JSONã‚’èª­ã¿è¾¼ã¿</span>
          </label>
        </div>
        <p class="muted small" style="margin-top:10px">ãƒ‡ãƒ¼ã‚¿ã¯ã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ï¼ˆlocalStorageï¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚åˆ¥ç«¯æœ«ã¸ç§»ã™å ´åˆã¯ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆâ†’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚</p>
      </section>
    </section>
  </div>

  <script>
    // ====== æ°¸ç¶šã‚­ãƒ¼ ======
    const STORAGE_KEY = 'habit_tracker_v1';
    const TIMER_KEY   = 'habit_tracker_timer_v1';
    const GOAL_KEY    = 'habit_tracker_goal_minutes_v1';

    // ====== ã‚¹ãƒ†ãƒ¼ãƒˆ ======
    let state = load();
    function load(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || { habits:[], logs:[] }; } catch{ return { habits:[], logs:[] }; } }
    function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

    // ====== Util ======
    const uid = (p='') => p + Math.random().toString(36).slice(2,9);
    const fmtDateTime = ts => new Date(ts).toLocaleString('ja-JP');
    const ymd = ts => new Date(ts).toISOString().slice(0,10);
    function randomColor(){ const hues=[300,210,160,40,0,120,260]; const h=hues[Math.floor(Math.random()*hues.length)]; return `hsl(${h} 90% 60%)`; }

    // ====== ã‚¿ãƒ–åˆ‡æ›¿ ======
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('.tab-btn');
      if(!btn) return;
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const id = btn.getAttribute('data-tab');
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      if(id==='tab-home') { renderCompounding(); }
    });

    // ====== ç¿’æ…£ ======
    function addHabit(){
      const name = document.getElementById('habit-name').value.trim();
      const color = document.getElementById('habit-color').value.trim() || randomColor();
      if(!name) return alert('ç¿’æ…£åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      state.habits.push({ id: uid('h_'), name, color }); save();
      document.getElementById('habit-name').value=''; document.getElementById('habit-color').value='';
      renderHabits(); populateSelects(); populateTimerSelect(); populateCompSelect(); renderAllCharts(); renderCompounding();
    }
    function removeHabit(id){
      if(!confirm('ã“ã®ç¿’æ…£ã¨é–¢é€£ãƒ­ã‚°ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
      state.logs = state.logs.filter(l=>l.habitId!==id);
      state.habits = state.habits.filter(h=>h.id!==id); save();
      renderHabits(); populateSelects(); populateTimerSelect(); populateCompSelect(); renderAllCharts(); renderCompounding();
    }
    function renderHabits(){
      const box = document.getElementById('habit-tags'); if(!box) return; box.innerHTML='';
      state.habits.forEach(h=>{
        const tag = document.createElement('div'); tag.className='tag';
        tag.innerHTML = `<span class="dot" style="background:${h.color}"></span><span>${h.name}</span>`;
        tag.title='ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠ / å³ã‚¯ãƒªãƒƒã‚¯ã§å‰Šé™¤';
        tag.onclick=()=>{ const s1=document.getElementById('habit-select'); const s2=document.getElementById('chart-habit'); const s3=document.getElementById('comp-habit'); if(s1) s1.value=h.id; if(s2) s2.value=h.id; if(s3) s3.value=h.id; renderAllCharts(); renderCompounding(); };
        tag.oncontextmenu=(e)=>{ e.preventDefault(); removeHabit(h.id); };
        box.appendChild(tag);
      });
    }
    function populateSelects(){
      const sel1=document.getElementById('habit-select'); const sel2=document.getElementById('chart-habit'); if(!sel1||!sel2) return;
      sel1.innerHTML=''; sel2.innerHTML=''; sel2.add(new Option('ï¼ˆå…¨ä½“é›†è¨ˆ/ä¸€éƒ¨ã‚°ãƒ©ãƒ•ã®ã¿ï¼‰','all'));
      state.habits.forEach(h=>{ sel1.add(new Option(h.name,h.id)); sel2.add(new Option(h.name,h.id)); });
    }

    // ====== è¨˜éŒ² ======
    function logTime(){
      const habitId = document.getElementById('habit-select').value || state.habits[0]?.id;
      const minutes = parseInt(document.getElementById('minutes').value,10);
      const when = document.getElementById('when').value;
      if(!habitId) return alert('å…ˆã«ç¿’æ…£ã‚’è¿½åŠ ã—ã¦ãã ã•ã„');
      if(!(minutes>0)) return alert('åˆ†æ•°ã¯1ä»¥ä¸Šã®æ•´æ•°ã§');
      const ts = when ? new Date(when).getTime() : Date.now();
      state.logs.unshift({ id: uid('l_'), habitId, minutes, ts }); save();
      document.getElementById('minutes').value=''; document.getElementById('when').value='';
      renderLogTable(); renderAllCharts(); renderCompounding();
    }
    function deleteLog(id){ state.logs = state.logs.filter(l=>l.id!==id); save(); renderLogTable(); renderAllCharts(); renderCompounding(); }
    function clearToday(){ const today=ymd(Date.now()); state.logs = state.logs.filter(l=>ymd(l.ts)!==today); save(); renderLogTable(); renderAllCharts(); renderCompounding(); }
    function renderLogTable(){
      const tbody=document.querySelector('#log-table tbody'); if(!tbody) return; tbody.innerHTML='';
      state.logs.slice(0,200).forEach(l=>{ const h=state.habits.find(h=>h.id===l.habitId); const tr=document.createElement('tr');
        tr.innerHTML=`<td>${fmtDateTime(l.ts)}</td><td>${h?h.name:'â€”'}</td><td>${l.minutes}</td><td><button onclick="deleteLog('${l.id}')">å‰Šé™¤</button></td>`; tbody.appendChild(tr); });
    }

    // ====== é›†è¨ˆ/ã‚°ãƒ©ãƒ• ======
    function dateRange(days){ const end=new Date(); end.setHours(23,59,59,999); const start=new Date(days==='all'?0:Date.now()-days*86400000); start.setHours(0,0,0,0); return [start.getTime(), end.getTime()]; }
    function filterLogsByRange(range){ const [s,e]=dateRange(range); return state.logs.filter(l=>l.ts>=s && l.ts<=e); }
    function daysBetween(a,b){ const d=86400000; const A=new Date(a); A.setHours(0,0,0,0); const B=new Date(b); B.setHours(0,0,0,0); return Math.round((B-A)/d)+1; }
    function buildDayAxis(range){ const [s,e]=dateRange(range); const n=daysBetween(s,e); const out=[]; for(let i=0;i<n;i++){ out.push(new Date(s+i*86400000).toISOString().slice(0,10)); } return out; }
    function timeOfDayHistogram(logs, habitId){ const bins=new Array(24).fill(0); logs.filter(l=>habitId==='all'?true:l.habitId===habitId).forEach(l=>{ bins[new Date(l.ts).getHours()]+=l.minutes; }); return bins; }
    function sumByHabit(logs){ const m=new Map(); logs.forEach(l=>m.set(l.habitId,(m.get(l.habitId)||0)+l.minutes)); return m; }
    function movingAverage(seq,w){ if(w<=1) return seq.slice(); const out=[]; for(let i=0;i<seq.length;i++){ const s=Math.max(0,i-w+1); let sum=0,c=0; for(let j=s;j<=i;j++){ sum+=seq[j]; c++; } out.push(sum/c); } return out; }

    let charts={ comp:null, cum:null, daily:null, tod:null, stack:null, pie:null }; let avgMode=1;
    function destroyChart(k){ if(charts[k]){ charts[k].destroy(); charts[k]=null; } }
    function chartColors(){ return state.habits.map(h=>h.color); }

    function baseOptions(unit, beginAtZero=false){ return { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ labels:{ color:'#cfe2ff' } }, tooltip:{ callbacks:{ label:(ctx)=>{ const v=ctx.parsed.y ?? ctx.parsed; return `${ctx.dataset.label||''} ${Math.round(v)} ${unit}`; } } } }, scales:{ x:{ ticks:{ color:'#cfe2ff', maxRotation:0 }, grid:{ color:'rgba(255,255,255,.05)' } }, y:{ beginAtZero, ticks:{ color:'#cfe2ff' }, grid:{ color:'rgba(255,255,255,.06)' } } } }; }

    function renderCum(){
      const habitId = document.getElementById('chart-habit').value || state.habits[0]?.id; const range=document.getElementById('range-select').value;
      const logs = filterLogsByRange(range).filter(l=>habitId==='all'?true:l.habitId===habitId);
      const axis = buildDayAxis(range); const perDay = new Map(axis.map(d=>[d,0]));
      logs.forEach(l=>{ const d=new Date(l.ts).toISOString().slice(0,10); if(perDay.has(d)) perDay.set(d, perDay.get(d)+l.minutes); });
      let cum=0; const series=axis.map(d=>cum += (perDay.get(d)||0));
      destroyChart('cum'); charts.cum=new Chart(document.getElementById('cumChart').getContext('2d'),{ type:'line', data:{ labels:axis, datasets:[{ label:'ç´¯è¨ˆï¼ˆåˆ†ï¼‰', data:series, borderWidth:2, fill:false, tension:.25 }] }, options: baseOptions('åˆ†') });
    }
    function renderDaily(){
      const habitId=document.getElementById('chart-habit').value || state.habits[0]?.id; const range=document.getElementById('range-select').value;
      const logs=filterLogsByRange(range); const axis=buildDayAxis(range); const map=new Map(axis.map(d=>[d,0]));
      logs.filter(l=>habitId==='all'?true:l.habitId===habitId).forEach(l=>{ const d=new Date(l.ts).toISOString().slice(0,10); if(map.has(d)) map.set(d,(map.get(d)||0)+l.minutes); });
      let series=axis.map(d=>map.get(d)||0); if(avgMode!==1) series=movingAverage(series,avgMode);
      destroyChart('daily'); charts.daily=new Chart(document.getElementById('dailyChart').getContext('2d'),{ type:'bar', data:{ labels:axis, datasets:[{ label:(avgMode===1?'æ—¥ã”ã¨': avgMode+'æ—¥å¹³å‡')+'ï¼ˆåˆ†ï¼‰', data:series }] }, options: baseOptions('åˆ†', true) });
    }
    function renderTOD(){ const habitId=document.getElementById('chart-habit').value || state.habits[0]?.id; const range=document.getElementById('range-select').value; const bins=timeOfDayHistogram(filterLogsByRange(range), habitId); destroyChart('tod'); charts.tod=new Chart(document.getElementById('todChart').getContext('2d'),{ type:'bar', data:{ labels:[...Array(24).keys()].map(h=>h+'æ™‚'), datasets:[{ label:'æ™‚é–“å¸¯åˆ¥ï¼ˆåˆ†ï¼‰', data:bins }] }, options: baseOptions('åˆ†', true) }); }
    function renderStack(){ const range=document.getElementById('range-select').value; const axis=buildDayAxis(range); const logs=filterLogsByRange(range); const byDay=new Map(axis.map(d=>[d,new Map()]));
      logs.forEach(l=>{ const d=new Date(l.ts).toISOString().slice(0,10); if(byDay.has(d)){ const m=byDay.get(d); m.set(l.habitId,(m.get(l.habitId)||0)+l.minutes); } }); const totals=axis.map(d=>Array.from(byDay.get(d).values()).reduce((a,b)=>a+b,0));
      const datasets=state.habits.map(h=>({ label:h.name, data: axis.map((d,i)=>{ const x=byDay.get(d).get(h.id)||0; const t=totals[i]||1; return (x/t)*100; }), stack:'stack', backgroundColor:h.color }));
      destroyChart('stack'); charts.stack=new Chart(document.getElementById('stackChart').getContext('2d'),{ type:'bar', data:{ labels:axis, datasets }, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'top', labels:{ color:'#cfe2ff' } }, tooltip:{ mode:'index', intersect:false } }, scales:{ x:{ stacked:true, ticks:{ color:'#cfe2ff', maxRotation:0 }, grid:{ color:'rgba(255,255,255,.05)' } }, y:{ stacked:true, min:0, max:100, ticks:{ color:'#cfe2ff', callback:v=>v+'%' }, grid:{ color:'rgba(255,255,255,.06)' } } } } }); }
    function renderPie(){ const range=document.getElementById('range-select').value; const logs=filterLogsByRange(range); const sums=sumByHabit(logs); const labels=state.habits.map(h=>h.name); const data=state.habits.map(h=>sums.get(h.id)||0); destroyChart('pie'); charts.pie=new Chart(document.getElementById('pieChart').getContext('2d'),{ type:'pie', data:{ labels, datasets:[{ data, backgroundColor: chartColors() }] }, options: baseOptions('åˆ†') }); }
    function renderAllCharts(){ renderCum(); renderDaily(); renderTOD(); renderStack(); renderPie(); }

    // ====== ãƒ›ãƒ¼ãƒ ï¼šè¤‡åˆ©ã‚°ãƒ©ãƒ• ======
    function populateCompSelect(){
      const sel=document.getElementById('comp-habit'); if(!sel) return; sel.innerHTML='';
      sel.add(new Option('å…¨ä½“ï¼ˆã™ã¹ã¦ã®ç¿’æ…£ï¼‰','all'));
      state.habits.forEach(h=> sel.add(new Option(h.name, h.id)));
    }
    function buildDailyMap(range){
      const axis = buildDayAxis(range);
      const byDay = new Map(axis.map(d=>[d, new Map()]));
      const logs = filterLogsByRange(range);
      logs.forEach(l=>{ const d=new Date(l.ts).toISOString().slice(0,10); if(byDay.has(d)){ const m=byDay.get(d); m.set(l.habitId,(m.get(l.habitId)||0)+l.minutes); }});
      return { axis, byDay };
    }
    function compSeries(range, habitId, goal){
      const {axis, byDay} = buildDailyMap(range);
      if(axis.length===0) return {axis:[], real:[], ideal:[]};
      goal = Math.max(1, Number(goal||0));
      let mult = 1.0; // åˆæœŸå€ç‡
      const real=[]; const ideal=[]; let idealMult=1.0;
      axis.forEach(d=>{
        let minutes=0;
        if(habitId==='all'){ byDay.get(d).forEach(v=> minutes+=v); }
        else { minutes = byDay.get(d).get(habitId)||0; }
        const rate = (minutes/goal) * 0.01; // ç›®æ¨™=1%
        mult *= (1 + rate);
        idealMult *= 1.01; // ç†æƒ³ï¼šæ¯æ—¥ã¡ã‚‡ã†ã©1%
        real.push(mult);
        ideal.push(idealMult);
      });
      return { axis, real, ideal };
    }
    function renderCompounding(){
      const habitId = document.getElementById('comp-habit').value || 'all';
      const range   = document.getElementById('comp-range').value || '365';
      const goal    = Number(document.getElementById('comp-goal').value) || Number(localStorage.getItem(GOAL_KEY)) || 30;
      document.getElementById('comp-goal').value = goal;
      localStorage.setItem(GOAL_KEY, String(goal));
      const {axis, real, ideal} = compSeries(range, habitId, goal);
      const statBox = document.getElementById('comp-stats');
      if(axis.length===0){ statBox.textContent='è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“'; destroyChart('comp'); return; }
      statBox.textContent = `é–‹å§‹å€ç‡1.00 â†’ ç¾åœ¨ ${real[real.length-1].toFixed(3)} å€ï¼ˆç†æƒ³ ${ideal[ideal.length-1].toFixed(3)} å€ï¼‰`;
      destroyChart('comp');
      charts.comp = new Chart(document.getElementById('compChart').getContext('2d'), {
        type:'line',
        data:{ labels:axis, datasets:[
          { label:'å®Ÿç¸¾ï¼ˆå€ç‡ï¼‰', data:real, borderWidth:2, fill:false, tension:.25 },
          { label:'ç†æƒ³ 1%/æ—¥', data:ideal, borderDash:[6,6], borderWidth:2, fill:false, tension:.25 }
        ]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ labels:{ color:'#cfe2ff' } }, tooltip:{ callbacks:{ label:(ctx)=>`${ctx.dataset.label}: ${ctx.parsed.y.toFixed(3)} å€` } } }, scales:{ x:{ ticks:{ color:'#cfe2ff', maxRotation:0 }, grid:{ color:'rgba(255,255,255,.05)' } }, y:{ beginAtZero:false, ticks:{ color:'#cfe2ff' }, grid:{ color:'rgba(255,255,255,.06)' } } } }
      });
    }

    // ====== åè¨€ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ï¼‰ ======
    const QUOTES = [
      { t:'æ¯æ—¥1%ã®é€²æ­©ãŒã€1å¹´å¾Œã«ã¯37å€ã®æˆé•·ã‚’ç”Ÿã‚€ã€‚', a:'ã‚¸ã‚§ãƒ¼ãƒ ã‚ºãƒ»ã‚¯ãƒªã‚¢' },
      { t:'ç¶™ç¶šã¯åŠ›ãªã‚Šã€‚', a:'æ—¥æœ¬ã®ã“ã¨ã‚ã–' },
      { t:'ç¶™ç¶šã“ããŒå¤©æ‰ã‚’ä½œã‚‹ã€‚', a:'ãƒ¬ã‚ªãƒŠãƒ«ãƒ‰ãƒ»ãƒ€ãƒ»ãƒ´ã‚£ãƒ³ãƒ' },
      { t:'è¤‡åˆ©ã¯äººé¡æœ€å¤§ã®ç™ºæ˜ã ã€‚', a:'ã‚¢ãƒ«ãƒ™ãƒ«ãƒˆãƒ»ã‚¢ã‚¤ãƒ³ã‚·ãƒ¥ã‚¿ã‚¤ãƒ³' },
      { t:'ä½•ã”ã¨ã‚’ãªã™ã«ã‚‚æ™‚ã¨ã„ã†ã‚‚ã®ãŒã‚ã‚‹ã€‚ã„ã‹ã«æœ›ã‚‚ã†ã¨ã€æ˜¥ãŒæ¥ãªã‘ã‚Œã°æ¡œã¯å’²ã‹ã¬ã€‚ã„ã‹ã«ã‚ã›ã‚ã†ã¨ã€æ™‚æœŸãŒæ¥ãªã‘ã‚Œã°äº‹ã¯æˆå°±ã›ã¬ã€‚', a:'æ¾ä¸‹å¹¸ä¹‹åŠ©' },
      { t:'æ¯æ—¥ã®å°ã•ãªåŠªåŠ›ã®ã¤ã¿é‡ã­ãŒã€æ­´å²ã‚’ä½œã£ã¦ã„ãã‚“ã ã‚ˆã€‚', a:'ãƒ‰ãƒ©ãˆã‚‚ã‚“' },
      { t:"No, I donâ€™t ever give up. Iâ€™d have to be dead or completely incapacitated.", a:'Elon Musk' }
    ];
    function shuffleQuote(){
      const q = QUOTES[Math.floor(Math.random()*QUOTES.length)];
      document.getElementById('quoteText').textContent = `â€œ${q.t}â€`;
      document.getElementById('quoteAuthor').textContent = `â€” ${q.a}`;
    }

    // ====== ãƒ‡ãƒ¼ã‚¿ I/O ======
    function exportData(){ const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='habit_data.json'; a.click(); URL.revokeObjectURL(url); }
    function importData(e){ const file=e.target.files[0]; if(!file) return; const r=new FileReader(); r.onload=()=>{ try{ const data=JSON.parse(r.result); if(!data||!Array.isArray(data.habits)||!Array.isArray(data.logs)) throw new Error('å½¢å¼ãŒä¸æ­£'); state=data; save(); renderHabits(); populateSelects(); populateTimerSelect(); populateCompSelect(); renderLogTable(); renderAllCharts(); renderCompounding(); } catch(err){ alert('èª­ã¿è¾¼ã¿å¤±æ•—: '+err.message); } }; r.readAsText(file,'utf-8'); e.target.value=''; }
    function resetAll(){ if(!confirm('ãƒ­ãƒ¼ã‚«ãƒ«ã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ')) return; state={ habits:[], logs:[] }; save(); renderHabits(); populateSelects(); populateTimerSelect(); populateCompSelect(); renderLogTable(); renderAllCharts(); renderCompounding(); }

    // ====== ã‚¿ã‚¤ãƒãƒ¼ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰è€æ€§ï¼‰ ======
    let timer = loadTimer(); let tickHandle=null; let wakeLock=null;
    function loadTimer(){ try{ return JSON.parse(localStorage.getItem(TIMER_KEY)) || { running:false, habitId:null, startTs:0, accMs:0, note:'' }; } catch{ return { running:false, habitId:null, startTs:0, accMs:0, note:'' }; } }
    function saveTimer(){ localStorage.setItem(TIMER_KEY, JSON.stringify(timer)); }
    function fmtHMS(ms){ const s=Math.floor(ms/1000); const hh=String(Math.floor(s/3600)).padStart(2,'0'); const mm=String(Math.floor((s%3600)/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return `${hh}:${mm}:${ss}`; }
    function timerNowMs(){ return timer.running ? (timer.accMs + (Date.now()-timer.startTs)) : timer.accMs; }
    function updateTimerUI(){ const disp=document.getElementById('timer-display'); const status=document.getElementById('timer-status'); const bP=document.getElementById('btn-pause'); const bR=document.getElementById('btn-resume'); if(!disp) return; disp.textContent=fmtHMS(timerNowMs()); status.textContent=timer.running ? 'è¨ˆæ¸¬ä¸­' : (timer.accMs>0 ? 'ä¸€æ™‚åœæ­¢ä¸­' : 'å¾…æ©Ÿä¸­'); if(bP) bP.style.display = timer.running? '':'none'; if(bR) bR.style.display = (!timer.running && timer.accMs>0)? '': 'none'; const sel=document.getElementById('timer-habit'); if(sel){ sel.innerHTML=''; state.habits.forEach(h=> sel.add(new Option(h.name,h.id))); if(timer.habitId) sel.value=timer.habitId; }
    }
    function startTick(){ if(tickHandle) return; tickHandle=setInterval(updateTimerUI,1000); }
    async function requestWakeLock(){ try{ if('wakeLock' in navigator){ if(wakeLock) return; wakeLock = await navigator.wakeLock.request('screen'); wakeLock.addEventListener('release', ()=>{ wakeLock=null; }); } } catch(_){} }
    document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible' && timer.running){ requestWakeLock(); } updateTimerUI(); });

    function timerStart(){ const sel=document.getElementById('timer-habit'); const note=document.getElementById('timer-note').value.trim(); const habitId= sel?.value || state.habits[0]?.id; if(!habitId) return alert('å…ˆã«ç¿’æ…£ã‚’è¿½åŠ ã—ã¦ãã ã•ã„'); timer={ running:true, habitId, startTs:Date.now(), accMs:0, note }; saveTimer(); requestWakeLock(); startTick(); updateTimerUI(); }
    function timerPause(){ if(!timer.running) return; timer.accMs += Date.now()-timer.startTs; timer.running=false; saveTimer(); updateTimerUI(); }
    function timerResume(){ if(timer.running) return; timer.startTs=Date.now(); timer.running=true; saveTimer(); requestWakeLock(); updateTimerUI(); }
    function timerReset(){ timer={ running:false, habitId: state.habits[0]?.id || null, startTs:0, accMs:0, note:'' }; saveTimer(); updateTimerUI(); }
    function timerCommit(){ const ms=timerNowMs(); const minutes=Math.max(1, Math.round(ms/60000)); if(!(minutes>0) || !timer.habitId) return alert('è¨ˆæ¸¬ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); state.logs.unshift({ id:uid('l_'), habitId:timer.habitId, minutes, ts:Date.now(), note: timer.note||undefined }); save(); timerReset(); renderLogTable(); renderAllCharts(); renderCompounding(); alert('ãƒ­ã‚°ã«è¿½åŠ ã—ã¾ã—ãŸï¼ˆ'+minutes+'åˆ†ï¼‰'); }

    // ====== åˆæœŸåŒ– ======
    function populateTimerSelect(){ const sel=document.getElementById('timer-habit'); if(!sel) return; sel.innerHTML=''; state.habits.forEach(h=> sel.add(new Option(h.name,h.id))); if(timer.habitId){ sel.value=timer.habitId; } }

    function baseInit(){
      // ã‚»ãƒ¬ã‚¯ãƒˆé¡
      renderHabits(); populateSelects(); populateTimerSelect(); populateCompSelect();
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé¸æŠ
      if(state.habits[0]){
        const s1=document.getElementById('habit-select'); const s2=document.getElementById('chart-habit'); const s3=document.getElementById('comp-habit');
        if(s1) s1.value=state.habits[0].id; if(s2) s2.value=state.habits[0].id; if(s3) s3.value='all';
      }
      // ç›®æ¨™æ™‚é–“ï¼ˆä¿æŒï¼‰
      const savedGoal = Number(localStorage.getItem(GOAL_KEY)||0) || 30; document.getElementById('comp-goal').value = savedGoal;
      // è¡¨ã‚„ã‚°ãƒ©ãƒ•
      renderLogTable(); renderAllCharts(); shuffleQuote(); renderCompounding();
      // ã‚¿ã‚¤ãƒãƒ¼UI
      updateTimerUI(); startTick();
    }

    baseInit();
  </script>
</body>
</html>
